#!/usr/bin/env groovy
pipeline {
    agent {
        docker {
            image 'frolvlad/alpine-java:jdk8-slim'   
            args '--network ci'        
        }
    }
 
    environment {
    ORG_NAME = "PMS"
        APP_NAME = "pms-demos-java-pipeline"
        APP_CONTEXT_ROOT = "//c//Program Files (x86)//Jenkins//jobs//PMS_API//workspace//"
        APP_LISTENING_PORT = "8081"
    TEST_CONTAINER_NAME = "ci-${APP_NAME}-${BUILD_NUMBER}"
    registry = "meerafse/pms"
    registryCredential = 'docker'
  } 
  stages {
    stage('Compile') {
        steps {
            echo "-=- compiling project -=-"
            sh "./mvnw clean compile"
        }
    } 
    stage('Package') {
        steps {
            echo "-=- packaging project -=-"
            sh "./mvnw package -DskipTests"
            archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
        }
    }
    stage('Build Docker image') {
        steps {
            echo "-=- build Docker image -=-"
            sh "./mvnw docker:build"
        }
    }  
    stage('Run Docker image') {
        steps {
            echo "-=- run Docker image -=-"
            sh "docker run --name ${TEST_CONTAINER_NAME}  ${ORG_NAME}/${APP_NAME}:latest"
        }
    }
    stage('Push Docker image') {
        steps {
            echo "-=- push Docker image -=-"
            sh "./mvnw docker:push"
        }
    }
}
    
}